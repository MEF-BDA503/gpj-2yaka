```{r, echo=FALSE}
multiplot <- function(..., plotlist = NULL, file, cols = 1, layout = NULL) {
  require(grid)

  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  if (is.null(layout)) {
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                 ncol = cols, nrow = ceiling(numPlots/cols))
}

if (numPlots == 1) {
print(plots[[1]])

} else {
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

for (i in 1:numPlots) {
  matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

  print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                  layout.pos.col = matchidx$col))
 }
}
 }
```

# Explanatory Data Analysis on HR Data

## Preparation
We start by loading required libraries for this study. 
```{r, message=FALSE}
library('tidyverse')
library("ggplot2")
library("ggcorrplot")

# install 'ggalt' pkg
  devtools::install_github("hrbrmstr/ggalt")
# options(scipen = 999)

 library('ggalt')
```


### Loading the Data
Then we read dataset from csv file and had a quick look at its form. 
```{r}
d=read.csv("HR_comma_sep.csv")
d<- d %>% rename("departments" = "sales") %>% tbl_df()
glimpse(d)

```
As you can see we have 14999 observations for job satisfaction level, latest evaluation (yearly), number of projects worked on, average monthly hours, time spend in the company (in years), work accident (within the past 2 years), promotion within the past 5 years, department and salary. All of them are numeric values except last two columns.

We also checked whether there is any NA or NaN values.
```{r}
which(is.na.data.frame(d))
```
Since there aren't any NA/NaN values, no need to omit or complete them. Thus we proceed summarizing the data.


```{r}
summary(d)
```
On average, the employees are 64% satisfied with their jobs; they have mean performance score of 0.71 (out of 1); an ordinary employee worked roughly on 3 - 4 different projects per year; it takes them 201.1 hours to complete their jobs per month; an avarage employee worked almost 3.5 years in the company (min = 2, max = 10); attrition rate is 23.81%; unfortunately only 2.1% of employees were promoted in the last 5 years. 8.24% of the employees are highly paid, 48.78% is lowly paid, 42.98% gets medium wage.

Having known all the column names and their related statistics, we wanted to visualize the distribution of the numerical ones, just to get better understanding for further interpretations. For this reason we employed histogram plots. Notice that bin sizes are adapted with respect to varying ranges of the data.

```{r}
p1 <- ggplot(subset(d ), aes(x=satisfaction_level, colour=satisfaction_level)) +
  theme(plot.title = element_text(size=12)) +
  geom_histogram(binwidth = 0.05,color = 'black', fill = '#999999') +
  ggtitle("Satisfaction Level") +
  labs(x="Job Satis. Score", y="Employee Count", size = 8)

p2 <- ggplot(subset(d ), aes(x=last_evaluation, colour=last_evaluation)) +
  theme(plot.title = element_text(size=12)) +
  geom_histogram(binwidth = 0.05,color = 'black', fill = '#009E73') +
  ggtitle("Last Evaluation") +
  labs(x="Performance Score", y="Employee Count", size = 8)

p3 <- ggplot(subset(d ), aes(x=number_project, colour=number_project)) +
   theme(plot.title = element_text(size=12)) +
  geom_histogram(binwidth = 1,color = 'black', fill = '#56B4E9') +
  ggtitle("Yearly Projects") +
  labs(x="Number of Projects", y="Employee Count", size = 8)

p4 <- ggplot(subset(d ), aes(x=average_montly_hours, colour=average_montly_hours)) +
  theme(plot.title = element_text(size=12)) +
  geom_histogram(binwidth = 10,color = 'black', fill = '#E69F00') +
  ggtitle("Average Monthly Hours")+
  labs(x="Monthly Hours", y="Employee Count", size = 8)
  

p5 <- ggplot(subset(d ), aes(x=time_spend_company, colour=time_spend_company)) +
  theme(plot.title = element_text(size=12)) +
  geom_histogram(binwidth = 0.5,color = 'black', fill = '#F0E442') +
  ggtitle("Time Spent in Company") +
  labs(x="Time (Years)", y="Employee Count", size = 8)

p6 <- ggplot(subset(d ), aes(x=Work_accident, colour=Work_accident)) +
  theme(plot.title = element_text(size=12)) +
  geom_bar(color = 'black', fill = '#0072B2') +
  ggtitle("Work Accidents") +
  labs(x="Accident Count", y="Employee Count", size = 8) +
  scale_x_continuous(breaks = c(0,1,1))

p7 <- ggplot(subset(d ), aes(x=left, colour=left)) +
  theme(plot.title = element_text(size=12)) +
  geom_bar(color = 'black', fill = '#D55E00') +
  ggtitle("Employees Left") +
  labs(x="Left Count", y="Employee Count", size = 8) +
  scale_x_continuous(breaks = c(0,1,1))


p8 <- ggplot(subset(d), aes(x=promotion_last_5years, colour=promotion_last_5years)) +
  theme(plot.title = element_text(size=12)) +
  scale_x_continuous(breaks = c(0,1,1)) +
  geom_bar(color = 'black', fill = '#CC79A7') +
  ggtitle("Promotion in 5 Years") +
  labs(x="Promotion Count", y="Employee Count", size = 8) 


multiplot(p1,p2,p3,p4,p5,p6,p7,p8,cols=3)
```

According to above histograms, we found that; there was nearly no promoted employee in the last five years. Bear in mind that the work accident data belongs to last two years and frequency of accidents is low but not zero. Monthly time spent in the company and number of projects which each employee works on both have positively skewed distributions. So, instead of mean, median value must be considered. Thus, a common employee works 4 projects per year, spending 200 hours per month.

```{r, echo=FALSE, eval=FALSE}
pltList <- list()
name <- names(d)
index = 1
for (colName in names(d)) {
    pltList[[index]] <- ggplot(d$colName,colour=d$colName) +
    geom_histogram(binwidth = 0.5,color = 'black', fill = '#9932CC') +
    ggtitle(colName) +
    labs(x= name[index], y="Employee Count")
    index = index + 1
}
multiplot(plotlist = pltList,cols = 2)

```

```{r,echo=FALSE, eval=FALSE}
 for (i in names(d)) { 
     print(ggplot(subset(d ), aes(x=d[i], colour=d$i)) +
   geom_histogram(binwidth = 0.05,color = 'black', fill = '#9932CC') +
   ggtitle("Last Evaluation") )
 }
```
Let's have a look at departmentwise job satisfaction level of the employees.

```{r}
 dep_satis <- d %>%
  group_by(departments) %>%
  summarise (Satisfaction =mean(satisfaction_level))
  ggplot(data=dep_satis, aes(x=departments, y=Satisfaction)) +
  theme(axis.text.x = element_text(angle = 60, hjust=1))+
  geom_bar(stat="identity", position=position_dodge(), fill="#FF9999", colour="black")
```

It appears that the level of satisfaction is pretty much the same for all the departments except for some unhappy folks in the accounting department. While rest of the departments average satisfaction value is around 60% (which complies with overall satisfaction rate of 61.28%), accounting department's mean is below the company's mean. May be we should focus on that department seperately.

```{r}
depLeftSatis <- d %>% group_by(departments) %>% summarise(Total =n(),LeftCount = sum(left), Satisfaction = mean(satisfaction_level) ) %>% mutate(LeftRate = LeftCount/Total) 

ggplot(data = depLeftSatis, aes( x = reorder(departments, -LeftRate), y = LeftRate, fill = Satisfaction)) +
    theme(axis.text.x = element_text(angle = 60, hjust=1))+
    geom_col()+labs(x= "Departments", y="Left Rate")
  
```

As satisfaction level increases, left rate decreases.

```{r}
depLeftSatis <- d %>% group_by(departments,salary) %>% summarise(Total =n(),LeftCount = sum(left), Satisfaction = mean(satisfaction_level) ) %>% mutate(LeftRate = LeftCount/Total)

ggplot(data = depLeftSatis, aes( x = reorder(departments, -LeftRate), y = LeftRate, fill=salary)) +
    theme(axis.text.x = element_text(angle = 60, hjust=1)) +
    geom_bar(stat="identity",position = "stack")+labs(x= "Departments", y="Left Rate")
  
```

Notice that altough job satisfaction level is uniformly distributed among the departments, the left rate varies abrubtly, maximized at the HR department. So there must be other factors that effect employee's decision to sign-out, such as salary.

Now, let's look at the categorical variables, salary and department name. We wanted to compare left and remained employee counts by departments and salary categories. When salary category does not give much insight about the characteristics of left people, we found that the 3 departments have considerably higher number of people left. These departments are sales, technical and support.

```{r}

p9 <- ggplot(d, aes(x=d$departments,fill=as.character(d$left) ))+
  theme(axis.text.x = element_text(angle = 60, hjust=1))+
  geom_bar() +
  labs(x="Departments", y="Employee Count", fill="Left or Not")

p10 <- ggplot(d, aes(x=d$salary,fill=as.character(d$left) ))+
      geom_bar() +
      labs(x="Salary", y ="Employee Count",fill="Left or Not")

multiplot(p9,p10,cols=2)
```

Let's see correlation matrix for whole company

```{r}
CorrMat <- round(cor(d[,0:8]),3)
ggcorrplot(CorrMat, hc.order = TRUE, 
           #type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="circle", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of Numeric Values", 
           ggtheme=theme_bw)
```

Maybe it is better to focus on the people who quit, already. We look at the correlation matrix of those to understand factors affecting their final decision to quit.

```{r}
dLeft <- d %>% filter(left==1) %>% select(-left)


 summary(dLeft)


```

We pairwise plotted job satisfaction level versus average montly hours and also satisfaction level versus time spent in the company. Meanwhile, we also highlighted employees left the company. 

```{r}

#Define three main groups which left the company 
d$left <- factor(d$left, labels=c("No", "Yes"))

gg <- ggplot(d,aes(satisfaction_level,average_montly_hours))

gg <- gg +geom_point(aes(col=factor(d$left)))

gg + geom_encircle(data=subset(d, 
                               satisfaction_level>=0.05 & 
                                 satisfaction_level<0.12 & 
                                 average_montly_hours>240 & 
                                 average_montly_hours<=310), colour="blue",expand=0.05,spread=0.02,size=2) +
  geom_encircle(data=subset(d, 
                               satisfaction_level>=0.35 & 
                                 satisfaction_level<0.47 & 
                                 average_montly_hours>122 & 
                                 average_montly_hours<164), colour="blue", expand=0,spread=0.02,size=2) +
    geom_encircle(data=subset(d, 
                               satisfaction_level>=0.47 & 
                                 satisfaction_level<=1 & 
                                 average_montly_hours>129 & 
                                 average_montly_hours<279), colour="green", expand=0, spread=0.02,size=2) +
      geom_encircle(data=subset(d, 
                               satisfaction_level>=0.715 & 
                                 satisfaction_level<=0.9 & 
                                 average_montly_hours>215 & 
                                 average_montly_hours<278), colour="blue", expand=0, spread=0.02,size=2) +

   scale_x_continuous(breaks=seq(0.08, 1, 0.08), limits = c(0.08, 1)) + 
  scale_y_continuous(breaks=seq(100, 315, 30), limits = c(100, 315)) +
  labs(x="Satisfaction Level",y="Avg. Monthly Hours", title="Satisfaction Level vs. Average Monthly Hours",col="Left Work") 
```

From the satisfaction vs. monthly hours plot, three seperate clusters are clearly seen with following properties:
 
+ *Group 1:* Low satisfaction level and long working hours
+ *Group 2:* Mediocre satisfaction level and low working hours 
+ *Group 3:* High satisfaction level and high working hours

It is no surprise that employees belonging to the first group quits the job. Furthermore, it would not be wrong to call the second group as **unmotivated** and the last group as **motivated**. It is very surprising to see motivated employees with such a high satisfaction level (>0.8) and long working hours. Those ones also must be the ones who works on more projects than the average, since average monthly hours highly correlates with number of projects.


```{r}

gg <- ggplot(d,aes(satisfaction_level,time_spend_company))

gg <- gg +geom_point(aes(col=factor(d$left)))

gg + geom_encircle(data=subset(d, 
                               satisfaction_level>=0.72 & 
                                 satisfaction_level<=0.92 & 
                                 time_spend_company>4 & 
                                 time_spend_company<6.02), colour="blue", expand=0.02,spread=0.02,size=2)+
  geom_encircle(data=subset(d, 
                               satisfaction_level>=0.36 & 
                                 satisfaction_level<=0.47 & 
                                 time_spend_company==3 ), colour="blue", expand=0.02,spread=0.02,size=2)+
    geom_encircle(data=subset(d, 
                               satisfaction_level>=0.08 & 
                                 satisfaction_level<=0.12 & 
                                 time_spend_company>=3 &
                                time_spend_company<=5), colour="blue", expand=0.02,spread=0.02,size=2)+

   scale_x_continuous(breaks=seq(0.08, 1, 0.08), limits = c(0.08, 1)) + 
  scale_y_continuous(breaks =  seq(0,10,by=2), limits = c(0,10))+
  labs(x="Satisfaction Level",y="Time Spend In Company (Years)", title="Satisfaction Level vs. Time Spend In Company (Years)",col="Left Work") 
```


From the graph above, it is seen that the motivated last group leaves the company between four and six years. May be they did not the promotion or salary increase they expected. People who passes six years thereshold, does not tend to leave the company later.

<!-- ## K-Means Clustering -->
<!-- ```{r} -->

<!-- #Get selected columns from data set -->
<!-- d2 <- d %>% select(satisfaction_level,average_montly_hours) -->

<!-- set.seed(35) -->

<!-- #apply k-means clustering -->
<!-- clusters<-kmeans(d2,centers=4) -->

<!-- #Get the clusters -->
<!-- mds_clusters<-data.frame(genre=names(genre_cluster$cluster),cluster_mds=genre_cluster$cluster) %>% arrange(cluster_mds,genre) -->
<!-- mds_clusters -->

<!-- ``` -->

```{r}

CorrMat <- round(cor(dLeft[,0:7]),3)
ggcorrplot(CorrMat, hc.order = TRUE, 
           #type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="circle", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of Numeric Values", 
           ggtheme=theme_bw)
```


Correlogram created from numerical values in our dataset shows that Average Monthly Hours is highly correlated with Number Of Projects as expected. The ones who works on more than avarage (3) projects, should spend more time in the company. And also last evaluation score correlates highly with number of projects and average monthly hours. High evaluation score is given to people who works on more projects by spending more time in the company. 

## Principal Component Analysis

Now, we are going to use this correlation matrix to make principal component analysis. Before that we need to transform salaries to numeric values to see their effect on left rate.
```{r}
names(dLeft)
dLeft_pca <- dLeft  %>% mutate(salary_Num = ifelse(salary == "low", 0, ifelse(salary == "medium", 1, 2))) %>% select(-salary,-departments)
survey_pca <-princomp(as.matrix(dLeft_pca[,1:8],cor=T))
summary(survey_pca,loadings=TRUE)
```

Cumulative variance plot is as below: 

```{r}

ggplot(data.frame(pc=1:5,cum_var=c(0.9996162, 0.9998254162, 0.9999774670, 0.9999894955,9.999969e-01)),aes(x=pc,y=cum_var)) + 
  geom_point() +
  geom_line() +
  labs(x="Principal Component Number",
       y="Cumulative Proportion", 
       title="Principal Component vs. Cumulative Proportion")

```


The first component explains %99 of the variance and it is exactly average mounthly hours! We are also surprised with this result as you are. We were expecting to see salary too as a negative factor effecting attirition rate. We are going build our prediction model just on this factor to see future run away employees.

## K-Means Clustering

We tried K-Means clustering to be able to group mass of people who left the company.


```{r}

#Filter to get the data from left people only
dleft<- subset(d, left=='Yes') 
dleft<- select(dleft,-left)


#apply k-means with 4 clusters and 20 iterations
set.seed(20)
dleft_Cluster <- kmeans(dleft[, 1:7], 4, nstart = 20)

dleft_Cluster

```

When we compare the values of 4 clusters with our previously defined groups in two graphs (Satisfaction Level vs. Avg. Monthly Hours, Satisfaction Level vs. Time Spend In Company), we found that there are similarities below:

+ Cluster 1 corresponds with Group 1 (Low satisfaction level (0.08 - 0.12) and long working hours (>240 hours))
+ Cluster 4 corresponds with Group 2 (Mediocre satisfaction level (0.36 - 0.45) and low working hours (120 - 160 hours))

As there are not enough samples in Group 3, basic k-means clustering we applied was not successful enough to discriminate the third Group (High satisfaction level and relatively high working hours). We think that further filtering is needed before reapplying clustering methods to this data. 




